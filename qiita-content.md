# 計画通り過ごしてるか15分ごとに質問してくるbotをGASで作った

## やったこと

「何もせず1か月経ってしまった..。  
計画を立ててもその通り行動できず、  
とりあえず現状に自覚的になろうと  
PCなりスマホで日々を記録しようとするも  
それすら続かない..。」  

という現状を打破すべく、自動でしつこく予定をリマインドしてくれて、  
わざわざPC・スマホでアプリを立ち上げなくても  
音声対話で記録してくれるがもの欲しいと思い、作ってみました。  

chromeとGASで動き、PCで音声認識・再生する想定のプログラムです。

1. googleカレンダーから予定を取得
2. GASとjsとスプレッドシートでリマインド音声を読み上げ
3. 返答するとその内容で分岐したり、記録したりしてくれる
4. 15分後新たなタブを開いて、再度予定をリマインドする

自分用に作ったのでかなり荒い作りです。  
スマートスピーカーもいいですが、googleアカウントとPCさえあれば動くので手軽に動かせます。  
アドバイスなどあればコメントください！

### 作ったコード

[https://github.com/hugepeach/GAS-talk-reminder](https://github.com/hugepeach/GAS-talk-reminder)にソース置いています

## 目次

1. 全体イメージ
2. スプレッドシートの作成
   1. カレンダー記録用シート
   2. 返答用辞書シート
   3. ログ記録用シート
3. ソースの作成 (from github)
   1. 音声合成 Synthesis (js)
   2. 音声認識 Recognition (js)
   3. 連携処理 (js & GAS)
4. 使い方
5. 音声リマインダーで日々の計画実行力は上がったか

## 1. 全体イメージ

- Google App Script
  - Google スプレッドシート
  - Google カレンダー
- javascript
  - Web Speech API
    - Speech Synthesis(音声合成)
    - Speech Recognition(音声認識)
- Chrome(実行環境)
- Windows(実行環境)
- マイク・スピーカー(PC内臓)

todo:picture

## 2. スプレッドシートの作成

スプレッドシートの準備をしていく  

① 適当な名前でスプレッドシートを作成  

② GASのプロジェクトを立ち上げる  

todo:picture

### 2-1. カレンダー記録用シート

カレンダーの予定タイトルと開始時間、終了時間を記録する用のシートを作成  

todo:calender picture

① シート「task」を作成

① todo:githubのCSVのパス のCSVを取り込む

### 2-2. 返答用辞書シート

聞き取った音声により返答する文言を分岐させる、辞書用のシートを作成  

① シート「dict」を作成

① todo:githubのCSVのパス のCSVを取り込む

### 2-3. ログ記録用シート

PCが読み上げた文言と、聞き取った言葉を記録する用のシートを作成  

① シート「log」を作成

① todo:githubのCSVのパス のCSVを取り込む

## 3. ソースの作成 (from github)

githubにあるソースをGASのプロジェクトに張り付けていき、数か所コードを自分用に変え、トリガーの設定をすれば動くようになる。  

ファイル通しの関係図は以下のイメージ👇
todo:picture

① ファイル名「コード.gs」をここからコピペし張り付ける  

② todo行目カレンダーのメールアドレス(todo)を書き換える  

todo:ditail

② todo行目のスプレッドシートのIDを書き換える  

todo:ditail

③ カレンダーから自動で予定を取得させるトリガーを設定する  

todo:detail
todo:picture

④ todowebアプリの公開をする

todo:picture
todo:detail

これでプログラムが動くようになった！

### 3-1. 音声合成 Synthesis (js)

`speech-synthesis.html`で音声合成する。  
Web Speech APIのSpeechRecognitionを利用。  
引数で受け取った値をそのまま読み上げる。発した音声は画面の`textarea id="speak_text"`に書き込む。

### 3-2. 音声認識 Recognition (js)

`speech-recognition.html`で音声認識する。  
Web Speech APIのSpeechRecognitionを利用。  
聞き取っている音声が途切れるのを検知し、音声認識する。聞き取った文言は画面の`textarea id="recognize_text"`に書き込む。  

### 3-3. 連携処理 (js & GAS)

「コード.gs」と「index.html」で`talk_data`という配列をやり取りし、条件分岐しながら音声返答している。

1. gasからhtmlを呼び出す
1. htmlが読まれたとき、15分間のカウントを始め、また現在時刻にカレンダーに予定されているタイトルを取得（@no1）
1. jsからカレンダーのタイトルを格納した`talk_data`をgasに送る
1. gasでdictシートの探索をし、返答文言を生成
   1. dictシートのA1セルから下に向かって、@no1に一致するセルを探す
   1. ＠no1に一致した後、右のセルに移動
   1. @otherを読み取り、さらに右のセルに移動
   1. @{}にカレンダーのタイトルを代入した文言を、`talk_data`に格納し`index.html`に返す
1. `speech-synthesis.html`の`speak`関数で音声合成
1. `speech-recognition.html`の`recognize`関数で読み取り開始
1. 読み取りが完了し、画面に文言が表示されたら認識した文言を`talk_data`に格納し再びgasに送る
1. 会話が終わるまで`talk_data`のやり取りを繰り返す。無言で1分経過、セルの値が`@exit`、セルの値が`@-`、dictシートの最終行に到達、エラーが発生した場合、処理を終了する
1. 15分後新しいタブを開き、`1.`から再度処理を開始

シートの参照方法👇
todo:picture

シートdictで返答文言を探す際のルールは、スプレッドシートの右の方にメモしてあります。

## 4. 使い方

アクセス

「～ですか？」聞かれるので、「違う」とか「はい」とか「～だから」としゃべりかけると、数秒間が空いて返答がくる。

予定イ通りの作業をしているか理由を聞かれと、冷静に今を客観視でき、またlogの使い方次第で自分が何にどれくらい時間をかけているのか分析できる。  
シートの右にメモを残したりできる。(一番下の行より下に値を入れない限りプログラムに影響しない)  

## 5. 音声リマインダーで日々の計画実行力は上がったか

音楽聞いてるとき、ラインとかの返信してるときとかにいきなりタブ開かれると腹が立つが、無意識にだらつくことが減ると思う(意識的にだらつく)。  
リマインダーというか目覚ましに近い気もする。

改良について

- googleアカウントさえあれば手軽に音声対話でき、簡単に拡張していける
- イヤホンのマイクだとうまく
- IFTTTとかと連動すると簡単に色々拡張できるかも

## 参考させて頂いた記事

Qiita: [Google Spread Sheetを用いた音声対話型チャットボットを作ってみた](https://qiita.com/glory/items/58091984715e968c3480)
Qiita: [Webページでブラウザの音声合成機能を使おう - Web Speech API Speech Synthesis](https://qiita.com/hmmrjn/items/be29c62ba4e4a02d305c)
